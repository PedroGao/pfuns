# 虚拟机原理与实现

## 概述

> A VM is a program that acts like a computer. It simulates a CPU along with a
> few other hardware components, allowing it to perform arithmetic, read and
> write to memory, and interact with I/O devices, just like a physical computer.

虚拟机本质上是对计算机的一种模拟，听起来这很绕，因为虚拟机大多也是运行在计算机上
的，也就是说，在计算机上运行的虚拟机在模拟计算机的运行。虚拟机会对
`CPU`，`内存`，`IO` 等核心组件进行模拟，让程序运行起来感觉就在实际的物理机上一样
。

举个例子来说，`NES` 是一种游戏模拟器，小时候玩的很多蓝白街机游戏，如`魂斗罗` 等
是不能直接在电脑上运行的，因为计算机的体系架构和游戏机不同，但是没关系我们可以使
用模拟器（虚拟机）在电脑上模拟游戏机的运行，那么在电脑上也可以打游戏了～

虚拟机有一个核心的好处，那就是可以屏蔽因计算机体系架构不同而带来的困扰。在这点上
，`Java`解决得很好，早期 Java 一直对外宣传`一次编写，到处运行`，那么这个到处运行
究竟是如何办到的呢？

我们知道对于不同的指令集，如`x86`和`ARM`，生成的可执行目标文件的格式和内容是不一
样的。就拿`c++`来举例子，在 `PC` 上编译的可执行文件是不能在手机上运行的，甚
至`windows`编译的`.exe`文件是不能直接在`linux`上运行的。

为了解决这点，很多编译器语言支持了`交叉编译`，比如`go`和`rust`，尤其是 go 的交叉
编译，相当的 cool。这些编译型语言必须得为每一种计算机架构、计算机平台都提供一种
编译方式来生成不同的目标文件，如下图：

```
+--------+     +---------+
| ARM 程序 | --> | ARM CPU |
+--------+     +---------+
+--------+     +---------+
| x86 程序 | --> | x86 CPU |
+--------+     +---------+
```

而 Java 选择了与他们不同的道路，实际上是 Java 先选择的虚拟机，Java 通过虚拟机来
屏蔽了指令集和计算机架构的不同，只需为每个不同的平台都实现一个虚拟机，在虚拟机上
就可以运行相同的 Java 代码，虚拟机模拟了不同平台的计算机，从而来使相同的 Java 代
码在不同的平台上产生了相同的效果。如下图：

```
+--------+     +---------+     +---------+
|   VM   | --> | ARM VM  | --> | ARM CPU |
+--------+     +---------+     +---------+
  |
  |
  v
+--------+     +---------+
| x86 VM | --> | x86 CPU |
+--------+     +---------+
```

## 虚拟机是银弹吗？

先给出结论：虚拟机不是银弹。

Java 虽然引入了虚拟机，但是也带来了巨大的运行时开销，诸如`Java 太耗内存`这些话虽
然有营销的嫌疑，但是无风不起浪，耗内存是切实存在。

再者，JVM 虽然是 Java 虚拟机，但它本质上是 `c++` 写的（有失偏颇，应该大部分代码
是 c++），这就造成了一个很麻烦的问题，想要深入理解 Java，必须要深入理解 JVM，毕
竟 JVM 调优已经成了标配。但是想要深入理解 JVM，能不看 JVM 源码吗？不能，因为只有
在源码面前，才能没有任何密码，所以在精通 JVM 的同时势必也必须精通 `c++`。

免费的永远是最贵的，JVM 虽然屏蔽了很多细节，给了开发者很大的便利，但同时也带来了
很大的学习坡度和曲线。

而`交叉编译`虽然规避了虚拟机了，但是支持编译到多个平台、多个架构是非常复杂和困难
的，要知道得找一个团队精通各种平台架构、成本太高！

## LC-3

LC-3 是一个非常精简的计算机体系架构，很多大学都使用它来教学生来学习汇编语言（可
惜了，国内的大学生哪有这种资源，哎～）。

你可以把它类比为一个非常简单的`x86`架构，LC-3 也有内存、寄存器、指令集

## 运行

运行 LC-3 的机器码，需要先使用编译器将 LC-3 汇编码编译成机器码，如下：

```sh
./lc3as hello
```

## 参考资料

- Write your Own Virtual Machine：https://justinmeiners.github.io/lc3-vm/
- LC3 help：http://lc3help.com/tutorials.htm?article=Basic_LC-3_Instructions/
- LC3：https://en.wikipedia.org/wiki/Little_Computer_3
- lc3-isa：https://justinmeiners.github.io/lc3-vm/supplies/lc3-isa.pdf
- lc3 lecture:
  https://www.cs.utexas.edu/users/fussell/courses/cs310h/lectures/Lecture_10-310h.pdf
